<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Luthier Manager v1.2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    :root { 
      --primary: #2C3E50; 
      --accent: #E67E22; 
      --bg: #F8F9FA; 
      --white: #FFFFFF;
    }
    
    body { 
      font-family: 'Montserrat', sans-serif; 
      background-color: var(--bg); 
      margin: 0; 
      padding: 0; 
      color: var(--primary);
    }

    .hidden { display: none !important; }

    /* ESTILOS DE LOGIN */
    #view-login {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      padding: 20px;
    }

    .login-card {
      background: var(--white);
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 350px;
      text-align: center;
    }

    /* ESTILOS DE COMPONENTES */
    input, textarea, select {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #DDD;
      border-radius: 8px;
      font-family: 'Montserrat';
      box-sizing: border-box;
    }

    button {
      width: 100%;
      padding: 12px;
      background-color: var(--primary);
      color: var(--white);
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    button.secondary { background-color: var(--accent); }
    button.ghost { background: transparent; color: var(--primary); border: 1px solid var(--primary); }

    /* DASHBOARD */
    .container { max-width: 600px; margin: auto; padding: 20px; }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .card {
      background: var(--white);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      margin-bottom: 15px;
    }

    .status-pill {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      background: #EEE;
    }

    /* ESTADOS SEGÚN PREFERENCIAS */
    .status-presente { background: #2ECC71; color: white; }
    .status-retardo { background: #F1C40F; color: black; }
    .status-ausente { background: #E74C3C; color: white; }
    .status-excusa { background: #3498DB; color: white; }

    /* CRONÓMETRO */
    #timer-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(44, 62, 80, 0.98);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #timer-clock { font-size: 80px; font-weight: bold; margin: 20px 0; }
  </style>
</head>
<body>

  <div id="view-login">
    <div class="login-card">
      <h2 style="margin-bottom: 30px;">LUTHIER MANAGER v1.2</h2>
      <input type="text" id="user" placeholder="USUARIO">
      <input type="password" id="pass" placeholder="CONTRASEÑA">
      <button onclick="ejecutarLogin()">INGRESAR</button>
      <p id="login-error" style="color: #E74C3C; font-size: 12px; margin-top: 15px;" class="hidden">DATOS INCORRECTOS</p>
    </div>
  </div>

  <div id="view-main" class="hidden">
    <div class="container">
      <div class="header">
        <h3 id="display-user">HOLA, LUTHIER</h3>
        <button class="ghost" style="width: auto; padding: 5px 15px;" onclick="cerrarSesion()">SALIR</button>
      </div>

      <div class="card">
        <input type="text" id="search-input" placeholder="BUSCAR POR SERIE O CLIENTE..." onkeyup="actualizarBusqueda(this.value)">
        <button class="secondary" onclick="mostrarVistaNuevo()">+ NUEVO INGRESO</button>
      </div>

      <div id="list-reparaciones">
        </div>
    </div>
  </div>

  <div id="view-new" class="hidden">
    <div class="container">
      <div class="card">
        <h3>REGISTRAR INGRESO</h3>
        <input type="text" id="form-cliente" placeholder="NOMBRE DE DUEÑO O AGRUPACIÓN">
        <input type="text" id="form-instrumento" placeholder="INSTRUMENTO">
        <input type="text" id="form-marca" placeholder="MARCA">
        <input type="text" id="form-serie" placeholder="NÚMERO DE SERIE">
        <textarea id="form-diagnostico" placeholder="DIAGNÓSTICO INICIAL" rows="4"></textarea>
        
        <button onclick="enviarFormulario()">GUARDAR EN DRIVE</button>
        <button class="ghost" onclick="mostrarVistaDashboard()" style="margin-top: 10px;">CANCELAR</button>
      </div>
    </div>
  </div>

  <div id="timer-overlay" class="hidden">
    <p>TRABAJANDO EN: <strong id="timer-tkt-id">#0000</strong></p>
    <div id="timer-clock">00:00:00</div>
    <div style="display: flex; gap: 15px;">
      <button onclick="detenerReloj(false)" style="background: #F1C40F; color: black;">PAUSAR</button>
      <button onclick="detenerReloj(true)" style="background: #E74C3C;">TERMINAR</button>
    </div>
  </div>

  <script>
    let sessionData = null;
    let clockInterval = null;
    let totalSeconds = 0;
    let activeTicketId = null;

    // --- AUTENTICACIÓN ---
    function ejecutarLogin() {
      const u = document.getElementById('user').value;
      const p = document.getElementById('pass').value;
      
      google.script.run.withSuccessHandler(res => {
        if(res.success) {
          sessionData = res;
          document.getElementById('view-login').classList.add('hidden');
          document.getElementById('view-main').classList.remove('hidden');
          document.getElementById('display-user').innerText = `HOLA, ${res.nombre.toUpperCase()}`;
          actualizarBusqueda('');
        } else {
          document.getElementById('login-error').classList.remove('hidden');
        }
      }).validarLogin(u, p);
    }

    function cerrarSesion() {
      location.reload();
    }

    // --- NAVEGACIÓN ---
    function mostrarVistaNuevo() {
      document.getElementById('view-main').classList.add('hidden');
      document.getElementById('view-new').classList.remove('hidden');
    }

    function mostrarVistaDashboard() {
      document.getElementById('view-new').classList.add('hidden');
      document.getElementById('view-main').classList.remove('hidden');
    }

    // --- FUNCIONES DE NEGOCIO ---
    function actualizarBusqueda(query) {
      google.script.run.withSuccessHandler(data => {
        const listDiv = document.getElementById('list-reparaciones');
        listDiv.innerHTML = '';
        
        data.forEach(item => {
          const statusClass = `status-${item.estado.toLowerCase()}`;
          listDiv.innerHTML += `
            <div class="card">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <strong>${item.inst.toUpperCase()} - ${item.marca.toUpperCase()}</strong>
                <span class="status-pill ${statusClass}">${item.estado}</span>
              </div>
              <p style="font-size: 13px; margin: 5px 0;">CLIENTE: ${item.cliente.toUpperCase()}</p>
              <p style="font-size: 12px; color: #777;">SERIE: ${item.serie} | TICKET: ${item.tkt}</p>
              <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button onclick="iniciarReloj('${item.tkt}')" style="font-size: 11px; padding: 8px;">TRABAJAR</button>
                <button class="secondary" onclick="abrirWhatsApp('${item.cliente}', '${item.inst}')" style="font-size: 11px; padding: 8px;">NOTIFICAR</button>
              </div>
            </div>`;
        });
      }).obtenerHistorial(sessionData.dbId, query);
    }

    function enviarFormulario() {
      const info = {
        cliente: document.getElementById('form-cliente').value,
        instrumento: document.getElementById('form-instrumento').value,
        marca: document.getElementById('form-marca').value,
        serie: document.getElementById('form-serie').value,
        diagnostico: document.getElementById('form-diagnostico').value
      };

      google.script.run.withSuccessHandler(() => {
        limpiarFormulario();
        mostrarVistaDashboard();
        actualizarBusqueda('');
      }).guardarIngreso(sessionData.dbId, info);
    }

    function limpiarFormulario() {
      ['form-cliente', 'form-instrumento', 'form-marca', 'form-serie', 'form-diagnostico'].forEach(id => {
        document.getElementById(id).value = '';
      });
    }

    // --- CRONÓMETRO ---
    function iniciarReloj(id) {
      activeTicketId = id;
      document.getElementById('timer-tkt-id').innerText = `#${id}`;
      document.getElementById('timer-overlay').classList.remove('hidden');
      totalSeconds = 0;
      
      clockInterval = setInterval(() => {
        totalSeconds++;
        const h = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
        const m = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
        const s = (totalSeconds % 60).toString().padStart(2, '0');
        document.getElementById('timer-clock').innerText = `${h}:${m}:${s}`;
      }, 1000);

      // Cambiar estado a RETARDO al iniciar trabajo
      google.script.run.actualizarReparacion(sessionData.dbId, id, "RETARDO", "");
    }

    function detenerReloj(finalizar) {
      clearInterval(clockInterval);
      const tiempoTranscurrido = document.getElementById('timer-clock').innerText;
      const estadoFinal = finalizar ? "PRESENTE" : "RETARDO"; 

      google.script.run.withSuccessHandler(() => {
        document.getElementById('timer-overlay').classList.add('hidden');
        actualizarBusqueda('');
      }).actualizarReparacion(sessionData.dbId, activeTicketId, finalizar ? "LISTO" : "RETARDO", tiempoTranscurrido);
    }

    function abrirWhatsApp(cliente, instrumento) {
      const texto = `HOLA ${cliente.toUpperCase()}, TU ${instrumento.toUpperCase()} YA ESTÁ LISTO. COORDINEMOS LA ENTREGA.`;
      const url = `https://wa.me/?text=${encodeURIComponent(texto)}`;
      window.open(url, '_blank');
    }
  </script>
</body>
</html>
