<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>LUTHIER MANAGER v1.5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    :root { --primary: #2C3E50; --accent: #E67E22; --bg: #F4F7F6; --white: #FFFFFF; --error: #C0392B; }
    body { font-family: 'Montserrat', sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: var(--primary); }
    .hidden { display: none !important; }

    /* LOADER */
    #loader {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.95); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .spinner { border: 5px solid #DDD; border-top: 5px solid var(--accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 0.8s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* LOGIN */
    #view-login { display: flex; align-items: center; justify-content: center; height: 100vh; }
    .login-card { background: var(--white); padding: 40px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 85%; max-width: 350px; text-align: center; }

    /* CONTENEDORES */
    .container { max-width: 550px; margin: auto; padding: 20px; }
    .card { background: var(--white); padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border-left: 6px solid var(--primary); }
    
    /* INPUTS Y BOTONES */
    input, textarea { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #E0E0E0; border-radius: 10px; font-family: 'Montserrat'; box-sizing: border-box; font-size: 16px; }
    button { width: 100%; padding: 14px; background-color: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; text-transform: uppercase; transition: 0.2s; margin-top: 5px; }
    button:active { transform: scale(0.97); }
    .secondary { background-color: var(--accent); }
    .ghost { background: transparent; color: var(--primary); border: 2px solid var(--primary); margin-top: 10px; }

    /* PILLS DE ESTADO */
    .pill { padding: 5px 12px; border-radius: 25px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
    .status-PRESENTE { background: #27AE60; color: white; }
    .status-RETARDO { background: #F1C40F; color: #2C3E50; }
    .status-AUSENTE { background: #E74C3C; color: white; }
    .status-EXCUSA { background: #3498DB; color: white; }

    /* CRON√ìMETRO */
    #timer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 5000; text-align: center; }
    #timer-clock { font-size: 75px; font-weight: 800; margin: 25px 0; font-variant-numeric: tabular-nums; letter-spacing: 2px; }
  </style>
</head>
<body>

  <div id="loader" class="hidden">
    <div class="spinner"></div>
    <p style="margin-top:20px; font-weight:700; color: var(--primary);">CONECTANDO AL SERVIDOR...</p>
  </div>

  <div id="view-login">
    <div class="login-card">
      <h1 style="font-size: 24px; margin: 0;">LUTHIER MANAGER</h1>
      <p style="font-size: 12px; color: #BDC3C7; margin-bottom: 35px; letter-spacing: 3px;">V1.5 PROFESSIONAL</p>
      
      <input type="text" id="user" placeholder="USUARIO">
      <input type="password" id="pass" placeholder="CONTRASE√ëA">
      <button onclick="auth()">INGRESAR</button>
      
      <p id="msg-login" style="color: var(--error); font-size: 12px; margin-top: 20px; font-weight: 700;" class="hidden"></p>
    </div>
  </div>

  <div id="view-main" class="hidden">
    <div class="container">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h2 style="margin:0; font-size: 18px;">HOLA, <span id="user-display">---</span></h2>
        <button class="ghost" style="width:auto; padding:8px 18px; font-size:11px;" onclick="location.reload()">CERRAR SESI√ìN</button>
      </div>

      <div class="card" style="border:none;">
        <input type="text" id="search-box" placeholder="üîç BUSCAR SERIE O CLIENTE..." onkeyup="fetchHistory(this.value)">
        <button class="secondary" onclick="changeView('new')">+ NUEVO REGISTRO</button>
      </div>

      <div id="list-results"></div>
    </div>
  </div>

  <div id="view-new" class="hidden">
    <div class="container">
      <div class="card">
        <h2 style="margin-top:0;">NUEVA ENTRADA</h2>
        <input type="text" id="f-cli" placeholder="NOMBRE DE DUE√ëO O AGRUPACI√ìN">
        <input type="text" id="f-ins" placeholder="INSTRUMENTO">
        <input type="text" id="f-mar" placeholder="MARCA">
        <input type="text" id="f-ser" placeholder="N√öMERO DE SERIE">
        <textarea id="f-dia" placeholder="DIAGN√ìSTICO INICIAL" rows="4"></textarea>
        <button onclick="saveEntry()">GUARDAR EN DRIVE</button>
        <button class="ghost" onclick="changeView('main')">CANCELAR</button>
      </div>
    </div>
  </div>

  <div id="timer-overlay" class="hidden">
    <p style="opacity:0.7; letter-spacing:2px; font-weight:700;">TRABAJANDO EN</p>
    <div id="tkt-active-label" style="font-size: 32px; font-weight: 700; color: var(--accent);">#TKT-0000</div>
    <div id="timer-clock">00:00:00</div>
    <div style="display: flex; gap: 20px;">
      <button onclick="stopClock(false)" style="background: #F1C40F; color: #2C3E50; width:140px;">PAUSAR</button>
      <button onclick="stopClock(true)" style="background: var(--error); width:140px;">TERMINAR</button>
    </div>
  </div>

  <script>
    let userData = null;
    let timerRef = null;
    let secCount = 0;
    let tktId = null;

    function toggleSpinner(show) {
      document.getElementById('loader').classList[show ? 'remove' : 'add']('hidden');
    }

    function changeView(view) {
      ['view-login', 'view-main', 'view-new'].forEach(v => document.getElementById(v).classList.add('hidden'));
      document.getElementById('view-' + view).classList.remove('hidden');
    }

    // --- AUTENTICACI√ìN ---
    function auth() {
      const u = document.getElementById('user').value;
      const p = document.getElementById('pass').value;
      const msg = document.getElementById('msg-login');
      
      if(!u || !p) return;
      toggleSpinner(true);
      msg.classList.add('hidden');

      google.script.run.withSuccessHandler(res => {
        toggleSpinner(false);
        if(res.success) {
          userData = res;
          document.getElementById('user-display').innerText = res.nombre.toUpperCase();
          changeView('main');
          fetchHistory('');
        } else {
          msg.innerText = res.error;
          msg.classList.remove('hidden');
        }
      }).withFailureHandler(err => {
        toggleSpinner(false);
        alert("ERROR CR√çTICO: " + err.message);
      }).validarLogin(u, p);
    }

    // --- BUSCADOR ---
    function fetchHistory(q) {
      google.script.run.withSuccessHandler(data => {
        const box = document.getElementById('list-results');
        box.innerHTML = '';
        if(data.length === 0) box.innerHTML = '<p style="text-align:center; opacity:0.5; margin-top:30px;">NO HAY RESULTADOS</p>';
        
        data.forEach(it => {
          const pillType = `status-${it.estado.toUpperCase()}`;
          box.innerHTML += `
            <div class="card">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <span style="font-weight:700;">${it.inst.toUpperCase()}</span>
                <span class="pill ${pillType}">${it.estado}</span>
              </div>
              <div style="font-size:13px; margin-bottom:15px; color:#555;">
                <b>${it.marca.toUpperCase()}</b> | SERIE: <b>${it.serie}</b><br>
                CLIENTE: ${it.cliente.toUpperCase()}
              </div>
              <div style="display:flex; gap:10px;">
                <button onclick="launchClock('${it.tkt}')" style="font-size:11px; padding:10px;">‚è±Ô∏è TRABAJAR</button>
                <button class="secondary" onclick="sendWa('${it.cliente}', '${it.inst}')" style="font-size:11px; padding:10px;">üì± AVISAR</button>
              </div>
            </div>`;
        });
      }).obtenerHistorial(userData.dbId, q);
    }

    // --- CRON√ìMETRO ---
    function launchClock(id) {
      tktId = id;
      document.getElementById('tkt-active-label').innerText = `#${id}`;
      document.getElementById('timer-overlay').classList.remove('hidden');
      secCount = 0;
      timerRef = setInterval(() => {
        secCount++;
        const h = Math.floor(secCount / 3600).toString().padStart(2, '0');
        const m = Math.floor((secCount % 3600) / 60).toString().padStart(2, '0');
        const s = (secCount % 60).toString().padStart(2, '0');
        document.getElementById('timer-clock').innerText = `${h}:${m}:${s}`;
      }, 1000);
      google.script.run.actualizarReparacion(userData.dbId, id, "RETARDO", "");
    }

    function stopClock(isFinish) {
      clearInterval(timerRef);
      const finalTime = document.getElementById('timer-clock').innerText;
      toggleSpinner(true);
      google.script.run.withSuccessHandler(() => {
        toggleSpinner(false);
        document.getElementById('timer-overlay').classList.add('hidden');
        fetchHistory('');
      }).actualizarReparacion(userData.dbId, tktId, isFinish ? "PRESENTE" : "RETARDO", finalTime);
    }

    // --- UTILIDADES ---
    function saveEntry() {
      const d = {
        cliente: document.getElementById('f-cli').value,
        instrumento: document.getElementById('f-ins').value,
        marca: document.getElementById('f-mar').value,
        serie: document.getElementById('f-ser').value,
        diagnostico: document.getElementById('f-dia').value
      };
      toggleSpinner(true);
      google.script.run.withSuccessHandler(() => {
        toggleSpinner(false);
        changeView('main');
        fetchHistory('');
      }).guardarIngreso(userData.dbId, d);
    }

    function sendWa(c, i) {
      const txt = `HOLA ${c.toUpperCase()}, TU ${i.toUpperCase()} EST√Å LISTO. COORDINEMOS LA ENTREGA.`;
      window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank');
    }
  </script>
</body>
</html>
