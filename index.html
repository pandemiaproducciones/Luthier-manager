<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luthier Manager v2.3</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #f3f4f6; }
        .uppercase-headers h1, .uppercase-headers h2, .uppercase-headers h3, .uppercase-headers th, .uppercase-input {
            text-transform: uppercase; letter-spacing: 0.05em;
        }
        
        /* Spinner */
        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); z-index: 50;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
        }
        .spinner {
            border: 8px solid #f3f3f3; border-top: 8px solid #1f2937;
            border-radius: 50%; width: 60px; height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Agenda Colores (Horas) */
        .slot-card { @apply flex flex-col items-center justify-center p-4 rounded border-2 transition text-center; }
        .slot-available { @apply bg-green-50 border-green-500 text-green-900 cursor-pointer hover:bg-green-500 hover:text-white transform hover:scale-105; }
        .slot-reserved { @apply bg-gray-200 border-gray-400 text-gray-500 cursor-not-allowed; }
        .slot-occupied { @apply bg-red-100 border-red-500 text-red-800 cursor-not-allowed opacity-75; }

        .btn-tile { @apply flex flex-col items-center justify-center p-10 rounded-xl shadow-xl transition transform hover:scale-105 cursor-pointer; }
        .timer-display { font-size: 12vw; font-weight: 800; line-height: 1; font-variant-numeric: tabular-nums; }
    </style>
</head>
<body class="text-gray-800 uppercase-headers">

    <div id="loader" class="loader-overlay hidden">
        <div class="spinner mb-4"></div>
        <p class="text-xl font-bold text-gray-800 animate-pulse">PROCESANDO...</p>
    </div>

    <section id="view-selection" class="min-h-screen flex flex-col items-center justify-center p-4 bg-gray-100">
        <div class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-black tracking-widest text-gray-900 mb-2">LUTHIER MANAGER</h1>
            <span class="bg-gray-900 text-white px-4 py-1 rounded-full text-sm font-bold tracking-widest">v2.3</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-4xl">
            <div onclick="goToClientView()" class="btn-tile bg-white border-b-8 border-gray-900">
                <i class="fa-solid fa-user text-6xl mb-4 text-gray-800"></i>
                <h2 class="text-3xl font-black">SOY CLIENTE</h2>
                <p class="text-sm text-gray-500 mt-2">RESERVAR CITA</p>
            </div>
            <div onclick="goToLogin()" class="btn-tile bg-gray-900 text-white border-b-8 border-gray-700">
                <i class="fa-solid fa-screwdriver-wrench text-6xl mb-4"></i>
                <h2 class="text-3xl font-black">SOY LUTHIER</h2>
                <p class="text-sm text-gray-400 mt-2">ADMINISTRACIÓN</p>
            </div>
        </div>
    </section>

    <section id="view-client" class="min-h-screen hidden bg-white">
        <header class="bg-gray-900 text-white p-4 flex justify-between items-center sticky top-0 z-30">
            <button onclick="goHome()" class="text-white hover:text-gray-300 font-bold flex items-center gap-2">
                <i class="fa-solid fa-arrow-left"></i> ATRÁS
            </button>
            <h1 class="font-bold">RESERVA TU CITA</h1>
            <div class="w-16"></div> </header>

        <div class="container mx-auto p-4 md:p-6 max-w-3xl">
            <div class="bg-white rounded-lg border-2 border-gray-200 shadow-lg p-4 mb-8">
                <div class="flex justify-between items-center mb-4 pb-4 border-b">
                    <button onclick="changeMonth(-1)" class="bg-gray-100 hover:bg-gray-200 text-gray-800 p-3 rounded-full transition">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <h2 id="monthDisplay" class="text-xl md:text-2xl font-black text-gray-900">CARGANDO...</h2>
                    <button onclick="changeMonth(1)" class="bg-gray-100 hover:bg-gray-200 text-gray-800 p-3 rounded-full transition">
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>

                <div class="grid grid-cols-7 gap-1 text-center font-bold text-xs md:text-sm text-gray-500 mb-2">
                    <div>DOM</div><div>LUN</div><div>MAR</div><div>MIÉ</div><div>JUE</div><div>VIE</div><div>SÁB</div>
                </div>

                <div id="calendarGrid" class="grid grid-cols-7 gap-1 md:gap-2">
                    </div>
            </div>

            <div id="slotsContainer" class="hidden">
                <h3 class="text-lg font-bold mb-4 border-b pb-2">HORARIOS DISPONIBLES EL <span id="displaySelectedDate" class="text-gray-500"></span></h3>
                <div id="slotsGrid" class="grid grid-cols-3 sm:grid-cols-4 gap-4 mb-8"></div>
            </div>
            
            <div id="clientForm" class="hidden bg-gray-50 p-6 rounded-lg border border-gray-200 mt-6 shadow-xl">
                <h3 class="font-bold mb-4 text-lg border-b pb-2">CONFIRMAR RESERVA</h3>
                <p class="mb-4 font-bold text-gray-700">HORA SELECCIONADA: <span id="displayTime" class="text-xl"></span></p>
                <div class="space-y-4">
                    <input type="text" id="clientName" placeholder="TU NOMBRE COMPLETO" class="w-full p-3 border rounded uppercase-input">
                    <input type="tel" id="clientPhone" placeholder="WHATSAPP (Ej: 57300...)" class="w-full p-3 border rounded">
                    <input type="hidden" id="selectedTime">
                    <button onclick="submitBooking()" class="w-full bg-gray-900 text-white font-bold py-4 rounded hover:bg-gray-800 transition">
                        ENVIAR SOLICITUD
                    </button>
                </div>
            </div>
        </div>
    </section>

    <section id="view-login" class="min-h-screen flex items-center justify-center bg-gray-900 p-4 hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md relative">
            <button onclick="goHome()" class="absolute top-4 left-4 text-gray-400 hover:text-gray-900 font-bold flex items-center gap-2">
                <i class="fa-solid fa-arrow-left"></i> ATRÁS
            </button>
            <h1 class="text-2xl font-bold mb-6 mt-6 text-center">ACCESO LUTHIER</h1>
            <form id="loginForm" class="space-y-6">
                <input type="text" id="user" placeholder="USUARIO" class="w-full p-3 border rounded" required>
                <input type="password" id="pass" placeholder="CLAVE" class="w-full p-3 border rounded" required>
                <button type="submit" class="w-full bg-gray-900 text-white font-bold py-4 rounded hover:bg-gray-800">INGRESAR</button>
            </form>
        </div>
    </section>

    <section id="view-dashboard" class="min-h-screen hidden bg-gray-50">
        <header class="bg-gray-900 text-white p-4 shadow-lg flex justify-between items-center sticky top-0 z-40">
            <span class="font-bold text-lg">LUTHIER MANAGER v2.3</span>
            <div class="flex items-center gap-4">
                <span id="luthierName" class="font-semibold text-sm hidden md:inline"></span>
                <button onclick="logout()" class="text-gray-400 hover:text-white" title="Cerrar Sesión"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </header>

        <div class="flex justify-center bg-white shadow mb-4">
            <button onclick="switchTab('reparaciones')" id="tab-reparaciones" class="py-4 px-8 font-bold border-b-4 border-gray-900">REPARACIONES</button>
            <button onclick="switchTab('agenda')" id="tab-agenda" class="py-4 px-8 font-bold text-gray-500">AGENDA <span id="badgeAgenda" class="bg-red-500 text-white text-xs px-2 rounded-full hidden">!</span></button>
        </div>

        <div class="container mx-auto p-4 max-w-6xl">
            <div id="panel-reparaciones">
                <div class="flex flex-col md:flex-row justify-between gap-4 mb-4">
                    <input type="text" id="searchInput" placeholder="BUSCAR..." class="w-full p-3 border rounded uppercase-input shadow-sm">
                    <button onclick="openNewTicketModal()" class="bg-gray-900 text-white px-6 py-3 rounded font-bold shadow-md hover:bg-gray-800 transition"><i class="fa-solid fa-plus"></i> NUEVO</button>
                </div>
                <div class="bg-white rounded shadow overflow-x-auto">
                    <table class="w-full text-left text-sm border-collapse">
                        <thead class="bg-gray-800 text-white">
                            <tr><th class="p-4">TICKET</th><th class="p-4">CLIENTE</th><th class="p-4">INSTRUMENTO</th><th class="p-4">ESTADO</th><th class="p-4">ACCIÓN</th></tr>
                        </thead>
                        <tbody id="jobsTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div id="panel-agenda" class="hidden">
                <h2 class="font-bold text-xl mb-4 text-gray-800">SOLICITUDES</h2>
                <div class="bg-white rounded shadow overflow-x-auto">
                    <table class="w-full text-left text-sm border-collapse">
                        <thead class="bg-gray-800 text-white">
                            <tr><th class="p-4">FECHA/HORA</th><th class="p-4">CLIENTE</th><th class="p-4">TELÉFONO</th><th class="p-4">ESTADO</th><th class="p-4">ACCIÓN</th></tr>
                        </thead>
                        <tbody id="agendaTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <section id="view-timer" class="fixed inset-0 bg-gray-900 text-white z-50 hidden flex flex-col p-6">
        <button onclick="closeTimer()" class="self-start text-gray-400 hover:text-white font-bold flex items-center gap-2 mb-4">
            <i class="fa-solid fa-arrow-left"></i> ATRÁS
        </button>
        <div class="flex-1 flex flex-col justify-center items-center text-center">
            <h2 id="timerInstrument" class="text-3xl font-bold text-gray-400 mb-2 uppercase-headers">GUITARRA</h2>
            <p id="timerClient" class="text-xl text-gray-500 mb-8 uppercase-headers">CLIENTE</p>
            <div id="timerDisplay" class="timer-display font-mono mb-8 text-white">00:00:00</div>
            <div class="flex gap-6">
                <button id="btnToggleTimer" onclick="toggleTimer()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-6 px-12 rounded-full text-2xl shadow-lg min-w-[200px] transition transform hover:scale-105">INICIAR</button>
                <button onclick="finishJob()" class="bg-red-600 hover:bg-red-500 text-white font-bold py-6 px-12 rounded-full text-2xl shadow-lg min-w-[200px] transition transform hover:scale-105">TERMINAR</button>
            </div>
        </div>
    </section>

    <div id="modalNewTicket" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded w-full max-w-lg overflow-hidden shadow-2xl">
            <div class="bg-gray-900 text-white p-4 font-bold flex justify-between items-center">
                <span>NUEVO TICKET</span>
                <button onclick="closeNewTicketModal()" class="text-gray-300 hover:text-white text-xl"><i class="fa-solid fa-times"></i></button>
            </div>
            <form id="newTicketForm" class="p-6 space-y-4">
                <input name="cliente" placeholder="CLIENTE" class="w-full p-3 border rounded uppercase-input shadow-sm" required>
                <input name="instrumento" placeholder="INSTRUMENTO" class="w-full p-3 border rounded uppercase-input shadow-sm" required>
                <input name="serie" placeholder="SERIE" class="w-full p-3 border rounded uppercase-input shadow-sm" required>
                <textarea name="diagnostico" placeholder="DIAGNÓSTICO" class="w-full p-3 border rounded uppercase-input shadow-sm" rows="3"></textarea>
                <button type="submit" class="w-full bg-gray-900 text-white font-bold py-4 rounded shadow-md hover:bg-gray-800 transition mt-4">CREAR TICKET</button>
            </form>
        </div>
    </div>

    <script>
        // --- TU URL ACTUALIZADA v2.3 ---
        const API_URL = "https://script.google.com/macros/s/AKfycbzrRXzlRaoySF_7X1C-ZvPWuLrIu4IcOaSo_Xjcqe2Chn_757m4cb5ovLfLOgtZJsJ2/exec";
        const PUBLIC_LUTHIER_ID = "1IHJac6AYB1ehc722umxZvOQSQLz4X-zL3bn1JYsvv3k";

        let currentUser = JSON.parse(localStorage.getItem('luthierUser')) || null;
        let activeTicket = null, timerInterval = null, secondsElapsed = 0, isTimerRunning = false;

        // Variables Calendario
        let nav = 0; // Control de mes (-1, 0, 1)
        let clickedDate = null; // YYYY-MM-DD
        let currentMonthAvailability = {}; 

        const monthNames = ["ENERO", "FEBRERO", "MARZO", "ABRIL", "MAYO", "JUNIO", "JULIO", "AGOSTO", "SEPTIEMBRE", "OCTUBRE", "NOVIEMBRE", "DICIEMBRE"];

        // --- NAVEGACIÓN ---
        function goHome() { 
            hideAllViews(); 
            document.getElementById('view-selection').classList.remove('hidden'); 
            // Resetear vistas interiores
            document.getElementById('slotsContainer').classList.add('hidden');
            document.getElementById('clientForm').classList.add('hidden');
            clickedDate = null;
        }
        function goToClientView() { 
            hideAllViews(); 
            document.getElementById('view-client').classList.remove('hidden'); 
            nav = 0; 
            loadMonth(); 
        }
        function goToLogin() { currentUser ? showDashboard() : (hideAllViews(), document.getElementById('view-login').classList.remove('hidden')); }
        function hideAllViews() { ['view-selection', 'view-client', 'view-login', 'view-dashboard', 'view-timer'].forEach(id => document.getElementById(id).classList.add('hidden')); }

        // --- LÓGICA CALENDARIO ---
        async function loadMonth() {
            const dt = new Date();
            if (nav !== 0) { dt.setMonth(new Date().getMonth() + nav); }
            const month = dt.getMonth() + 1;
            const year = dt.getFullYear();

            document.getElementById('monthDisplay').innerText = `${monthNames[month - 1]} ${year}`;
            
            showLoader(true);
            try {
                const res = await fetchAPI({ action: 'getMonthAvailability', sheetId: PUBLIC_LUTHIER_ID, year: year, month: month });
                if(res.status === 'success') { currentMonthAvailability = res.data; }
            } catch(e) { console.error(e); }
            showLoader(false);

            renderCalendar(year, month);
        }

        function changeMonth(offset) {
            nav += offset;
            document.getElementById('slotsContainer').classList.add('hidden');
            document.getElementById('clientForm').classList.add('hidden');
            loadMonth();
        }

        function renderCalendar(year, month) {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            const firstDay = new Date(year, month - 1, 1);
            const daysInMonth = new Date(year, month, 0).getDate();
            const paddingDays = firstDay.getDay(); // 0 (Dom) a 6 (Sáb)
            
            const today = new Date();
            today.setHours(0,0,0,0); // Normalizar hoy para comparar

            for(let i = 1; i <= paddingDays + daysInMonth; i++) {
                const daySquare = document.createElement('div');
                daySquare.classList.add('flex', 'flex-col', 'items-center', 'justify-center', 'p-2', 'md:p-4', 'rounded', 'border', 'transition', 'aspect-square');
                
                if (i > paddingDays) {
                    const dayNumber = i - paddingDays;
                    const dateObj = new Date(year, month - 1, dayNumber);
                    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
                    
                    daySquare.innerHTML = `<span class="text-lg md:text-xl font-bold">${dayNumber}</span>`;
                    
                    // Lógica de colores y disponibilidad
                    if (dateObj < today) {
                        daySquare.classList.add('bg-gray-100', 'text-gray-300', 'border-transparent', 'cursor-not-allowed');
                    } else {
                        const status = currentMonthAvailability[dateStr];
                        
                        if (status === 'FULL') {
                            daySquare.classList.add('bg-red-50', 'text-red-800', 'border-red-400', 'cursor-not-allowed', 'opacity-75');
                            daySquare.innerHTML += `<span class="text-[9px] md:text-xs font-bold mt-1 uppercase text-red-600">LLENO</span>`;
                        } else if (status === 'PARTIAL') {
                            daySquare.classList.add('bg-yellow-50', 'text-yellow-800', 'border-yellow-400', 'cursor-pointer', 'hover:bg-yellow-200');
                            daySquare.innerHTML += `<span class="text-[9px] md:text-xs font-bold mt-1 uppercase text-yellow-600">DISP.</span>`;
                            daySquare.addEventListener('click', () => selectCalendarDate(dateStr));
                        } else {
                            // Libre
                            daySquare.classList.add('bg-green-50', 'text-green-900', 'border-green-400', 'cursor-pointer', 'hover:bg-green-500', 'hover:text-white');
                            daySquare.innerHTML += `<span class="text-[9px] md:text-xs font-bold mt-1 uppercase text-green-700 hover:text-white">LIBRE</span>`;
                            daySquare.addEventListener('click', () => selectCalendarDate(dateStr));
                        }
                    }

                    // Destacar si está seleccionado
                    if(clickedDate === dateStr) {
                         daySquare.classList.add('ring-4', 'ring-gray-900');
                    }
                } else {
                    daySquare.classList.add('invisible');
                }
                
                grid.appendChild(daySquare);
            }
        }

        function selectCalendarDate(dateStr) {
            clickedDate = dateStr;
            const parts = dateStr.split('-');
            document.getElementById('displaySelectedDate').innerText = `${parts[2]}/${parts[1]}/${parts[0]}`;
            
            // Re-render para aplicar el anillo (ring) de selección visual
            const dt = new Date(parts[0], parseInt(parts[1]) - 1, parts[2]);
            renderCalendar(dt.getFullYear(), dt.getMonth() + 1);
            
            document.getElementById('clientForm').classList.add('hidden');
            loadSlotsForDate(dateStr);
        }

        async function loadSlotsForDate(dateStr) {
            showLoader(true);
            try {
                const res = await fetchAPI({ action: "getAvailableSlots", sheetId: PUBLIC_LUTHIER_ID, date: dateStr });
                const grid = document.getElementById('slotsGrid');
                grid.innerHTML = '';
                document.getElementById('slotsContainer').classList.remove('hidden');
                
                // Bajar suavemente la pantalla hasta las horas
                document.getElementById('slotsContainer').scrollIntoView({behavior: 'smooth', block: 'start'});

                if (res.slots && res.slots.length > 0) {
                    res.slots.forEach(slot => {
                        const div = document.createElement('div');
                        let statusClass = "slot-available";
                        let labelText = "DISPONIBLE";
                        let canClick = true;

                        if(slot.status === "OCUPADO") { statusClass = "slot-occupied"; labelText = "OCUPADO"; canClick = false; }
                        else if (slot.status === "RESERVADO") { statusClass = "slot-reserved"; labelText = "RESERVADO"; canClick = false; }

                        div.className = `slot-card ${statusClass}`;
                        div.innerHTML = `<span class="text-xl md:text-2xl font-bold">${slot.time}</span><span class="text-xs font-bold mt-1">${labelText}</span>`;
                        if(canClick) div.onclick = () => selectSlot(slot.time, div);
                        grid.appendChild(div);
                    });
                } else {
                    grid.innerHTML = '<p class="col-span-3 text-red-500 font-bold">No hay horarios disponibles.</p>';
                }
            } catch(e) { console.error(e); }
            showLoader(false);
        }

        function selectSlot(time, element) {
            document.querySelectorAll('.slot-available').forEach(el => { el.classList.remove('bg-gray-900', 'text-white', 'border-gray-900'); el.classList.add('bg-green-50', 'text-green-900', 'border-green-500'); });
            element.classList.remove('bg-green-50', 'text-green-900', 'border-green-500'); element.classList.add('bg-gray-900', 'text-white', 'border-gray-900');
            document.getElementById('selectedTime').value = time;
            document.getElementById('displayTime').textContent = time;
            document.getElementById('clientForm').classList.remove('hidden');
            document.getElementById('clientForm').scrollIntoView({behavior: 'smooth'});
        }

        async function submitBooking() {
            const time = document.getElementById('selectedTime').value;
            const name = document.getElementById('clientName').value;
            const phone = document.getElementById('clientPhone').value;
            if(!name || !phone) return Swal.fire('Falta info', 'Llena nombre y teléfono', 'warning');

            showLoader(true);
            await fetchAPI({ action: "bookAppointment", sheetId: PUBLIC_LUTHIER_ID, bookingData: { fecha: clickedDate, hora: time, cliente: name, telefono: phone } });
            Swal.fire('Solicitud Enviada', 'El luthier confirmará pronto.', 'success').then(() => window.location.reload());
            showLoader(false);
        }

        // --- DASHBOARD Y RESTO DE FUNCIONES ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault(); showLoader(true);
            const res = await fetchAPI({ action: "login", usuario: document.getElementById('user').value, clave: document.getElementById('pass').value });
            showLoader(false);
            if(res.status === 'success') { currentUser = res.data; localStorage.setItem('luthierUser', JSON.stringify(currentUser)); showDashboard(); }
            else Swal.fire('Error', 'Credenciales incorrectas', 'error');
        });

        function showDashboard() {
            hideAllViews(); document.getElementById('view-dashboard').classList.remove('hidden');
            document.getElementById('luthierName').textContent = currentUser.nombre;
            switchTab('reparaciones');
        }

        function switchTab(tab) {
            document.getElementById('panel-reparaciones').classList.add('hidden'); document.getElementById('panel-agenda').classList.add('hidden');
            document.getElementById('tab-reparaciones').classList.remove('border-b-4', 'border-gray-900', 'text-gray-900');
            document.getElementById('tab-agenda').classList.remove('border-b-4', 'border-gray-900', 'text-gray-900');
            document.getElementById(`tab-${tab}`).classList.add('border-b-4', 'border-gray-900', 'text-gray-900');
            document.getElementById(`panel-${tab}`).classList.remove('hidden');
            if(tab === 'reparaciones') loadReparaciones(); else { showLoader(true); loadAgenda().then(() => showLoader(false)); }
        }

        async function loadReparaciones() {
            showLoader(true);
            const res = await fetchAPI({ action: "getDashboardData", sheetId: currentUser.sheetId });
            const tbody = document.getElementById('jobsTableBody'); tbody.innerHTML = '';
            res.data.forEach(job => tbody.innerHTML += `<tr class="border-b hover:bg-gray-100 transition"><td class="p-4 font-bold text-gray-900">${job.ticketId}</td><td class="p-4">${job.cliente}</td><td class="p-4 text-gray-600">${job.instrumento}</td><td class="p-4"><span class="bg-yellow-100 px-3 py-1 rounded-full font-bold text-xs shadow-sm">${job.estado}</span></td><td class="p-4"><button onclick='openTimer(${JSON.stringify(job)})' class="text-gray-900 hover:text-blue-600 text-xl transition"><i class="fa-solid fa-clock"></i></button></td></tr>`);
            showLoader(false);
        }

        async function loadAgenda() {
            const res = await fetchAPI({ action: "getAgendaRequests", sheetId: currentUser.sheetId });
            const tbody = document.getElementById('agendaTableBody'); tbody.innerHTML = '';
            
            if(!res.data || res.data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500 font-bold">NO HAY SOLICITUDES PENDIENTES</td></tr>'; return; }

            res.data.forEach(c => {
                const isPending = c.estado === 'PENDIENTE';
                tbody.innerHTML += `<tr class="border-b ${isPending?'bg-blue-50':''}"><td class="p-4 font-bold">${c.fecha}<br><span class="text-xs font-normal text-gray-500">${c.hora}</span></td><td class="p-4 font-bold uppercase">${c.cliente}</td><td class="p-4">${c.telefono}</td><td class="p-4 font-bold text-xs">${c.estado}</td><td class="p-4">${isPending ? `<button onclick="confirmCita('${c.id}','CONFIRMADA')" class="bg-green-500 text-white p-2 rounded shadow hover:bg-green-400 mr-2 transition" title="Confirmar"><i class="fa-solid fa-check"></i></button><button onclick="confirmCita('${c.id}','RECHAZADA')" class="bg-red-500 text-white p-2 rounded shadow hover:bg-red-400 transition" title="Rechazar"><i class="fa-solid fa-times"></i></button>` : '-'}</td></tr>`;
            });
        }

        async function confirmCita(id, status) {
            showLoader(true);
            try {
                const res = await fetchAPI({ action: "confirmAppointment", sheetId: currentUser.sheetId, citaId: id, status: status });
                if(res.status === 'success' && status === 'CONFIRMADA') {
                    const d = res.data;
                    const url = `https://wa.me/${d.telefono.replace(/\D/g,'')}?text=${encodeURIComponent(`HOLA ${d.cliente}, TU CITA EL ${d.fecha} A LAS ${d.hora} HA SIDO CONFIRMADA.`)}`;
                    window.open(url, '_blank');
                }
                await loadAgenda();
            } catch (error) { console.error(error); Swal.fire('Error', 'Hubo un problema.', 'error'); } 
            finally { showLoader(false); }
        }

        async function fetchAPI(data) { const r = await fetch(API_URL, { method: "POST", body: JSON.stringify(data) }); return await r.json(); }
        function showLoader(show) { document.getElementById('loader').classList.toggle('hidden', !show); }
        function logout() { localStorage.removeItem('luthierUser'); location.reload(); }
        
        function openTimer(job) { activeTicket=job; document.getElementById('view-timer').classList.remove('hidden'); document.getElementById('timerInstrument').textContent=job.instrumento; document.getElementById('timerClient').textContent=job.cliente; secondsElapsed=parseTime(job.tiempo); updateDisplay(); isTimerRunning=false; updateTimerUI(); }
        function toggleTimer() { if(isTimerRunning){clearInterval(timerInterval);isTimerRunning=false;}else{timerInterval=setInterval(()=>{secondsElapsed++;updateDisplay();},1000);isTimerRunning=true;} updateTimerUI(); }
        function updateTimerUI() { const btn=document.getElementById('btnToggleTimer'); if(isTimerRunning){btn.innerHTML='<i class="fa-solid fa-pause"></i> PAUSAR';btn.className="bg-yellow-500 hover:bg-yellow-400 text-white font-bold py-6 px-12 rounded-full text-2xl shadow-lg min-w-[200px] transition transform hover:scale-105";}else{btn.innerHTML='<i class="fa-solid fa-play"></i> INICIAR';btn.className="bg-green-600 hover:bg-green-500 text-white font-bold py-6 px-12 rounded-full text-2xl shadow-lg min-w-[200px] transition transform hover:scale-105";} }
        function updateDisplay() { document.getElementById('timerDisplay').textContent=`${pad(Math.floor(secondsElapsed/3600))}:${pad(Math.floor((secondsElapsed%3600)/60))}:${pad(secondsElapsed%60)}`; }
        async function finishJob() { if(isTimerRunning)toggleTimer(); const finalTime=document.getElementById('timerDisplay').textContent; const {value:confirm}=await Swal.fire({title:'¿TERMINAR?',text:`Tiempo: ${finalTime}`,icon:'warning',showCancelButton:true}); if(confirm){ showLoader(true); await fetchAPI({action:"saveTicket",sheetId:currentUser.sheetId,ticketData:{id:activeTicket.ticketId,cliente:activeTicket.cliente,instrumento:activeTicket.instrumento,serie:activeTicket.serie,estado:"TERMINADO",diagnostico:"TIEMPO: "+finalTime}}); closeTimer(); loadReparaciones(); showLoader(false); Swal.fire('Listo','','success'); } }
        function closeTimer() { if(isTimerRunning)clearInterval(timerInterval); document.getElementById('view-timer').classList.add('hidden'); }
        function pad(v){return v>9?v:"0"+v} function parseTime(t){if(!t)return 0;if(typeof t==='object'){let d=new Date(t);return d.getHours()*3600+d.getMinutes()*60+d.getSeconds()}if(typeof t==='string'&&t.includes(':')){let p=t.split(':');return (+p[0])*3600+(+p[1])*60+(+p[2])}return 0;}
        function openNewTicketModal() { document.getElementById('modalNewTicket').classList.remove('hidden'); }
        function closeNewTicketModal() { document.getElementById('modalNewTicket').classList.add('hidden'); }
        document.getElementById('newTicketForm').addEventListener('submit', async(e)=>{ e.preventDefault(); showLoader(true); await fetchAPI({action:"saveTicket", sheetId:currentUser.sheetId, ticketData:Object.fromEntries(new FormData(e.target))}); closeNewTicketModal(); loadReparaciones(); showLoader(false); });
    </script>
</body>
</html>
