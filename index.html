<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luthier Manager v1.0</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #f3f4f6; }
        .font-montserrat { font-family: 'Montserrat', sans-serif; }
        
        /* Spinner */
        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); z-index: 50;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
        }
        .spinner {
            border: 8px solid #f3f3f3; border-top: 8px solid #1f2937;
            border-radius: 50%; width: 60px; height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Clases de utilidad */
        .uppercase-headers h1, .uppercase-headers h2, .uppercase-headers h3, .uppercase-headers th {
            text-transform: uppercase; letter-spacing: 0.05em;
        }
        .btn-primary { @apply bg-gray-900 text-white font-bold py-3 px-6 rounded shadow hover:bg-gray-700 transition duration-300; }
        .btn-secondary { @apply bg-white text-gray-900 border-2 border-gray-900 font-bold py-3 px-6 rounded shadow hover:bg-gray-100 transition duration-300; }
        
        /* Cronómetro Gigante */
        .timer-display { font-size: 15vw; font-weight: 800; line-height: 1; font-variant-numeric: tabular-nums; }
    </style>
</head>
<body class="text-gray-800 uppercase-headers">

    <div id="loader" class="loader-overlay hidden">
        <div class="spinner mb-4"></div>
        <p class="text-xl font-bold text-gray-800 animate-pulse">PROCESANDO DATOS...</p>
    </div>

    <section id="view-login" class="min-h-screen flex items-center justify-center bg-gray-900 p-4">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fa-solid fa-guitar text-5xl text-gray-900 mb-4"></i>
                <h1 class="text-2xl font-bold mb-1">LUTHIER MANAGER v1.0</h1>
                <p class="text-sm text-gray-500">ACCESO AL TALLER</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">USUARIO</label>
                    <input type="text" id="user" class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-gray-900 uppercase" required>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">CLAVE</label>
                    <input type="password" id="pass" class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-gray-900" required>
                </div>
                <button type="submit" class="w-full bg-gray-900 text-white font-bold py-4 rounded hover:bg-gray-800 transition">INGRESAR</button>
            </form>
        </div>
    </section>

    <section id="view-dashboard" class="min-h-screen hidden">
        <header class="bg-gray-900 text-white p-4 shadow-lg flex justify-between items-center sticky top-0 z-40">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-music"></i>
                <span class="font-bold text-lg hidden md:inline">LUTHIER MANAGER v1.0</span>
            </div>
            <div class="flex items-center gap-4">
                <span id="luthierName" class="font-semibold text-sm"></span>
                <button onclick="logout()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </header>

        <div class="container mx-auto p-4 max-w-6xl">
            <div class="flex flex-col md:flex-row justify-between gap-4 mb-8 mt-4">
                <div class="relative w-full md:w-1/2">
                    <input type="text" id="searchInput" placeholder="BUSCAR SERIE O CLIENTE..." 
                           class="w-full p-4 pl-12 border-2 border-gray-300 rounded-lg shadow-sm focus:border-gray-900 outline-none text-lg uppercase">
                    <i class="fa-solid fa-search absolute left-4 top-5 text-gray-400"></i>
                </div>
                <button onclick="openNewTicketModal()" class="btn-primary flex items-center justify-center gap-2">
                    <i class="fa-solid fa-plus"></i> NUEVO TICKET
                </button>
            </div>

            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="p-4 bg-gray-100 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="font-bold text-gray-700"><i class="fa-solid fa-list-check mr-2"></i>TRABAJOS ACTIVOS</h2>
                    <button onclick="loadDashboard()" class="text-sm text-gray-600 underline">ACTUALIZAR</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-800 text-white text-sm">
                                <th class="p-4">TICKET</th>
                                <th class="p-4">CLIENTE</th>
                                <th class="p-4">INSTRUMENTO</th>
                                <th class="p-4">ESTADO</th>
                                <th class="p-4 text-center">ACCIÓN</th>
                            </tr>
                        </thead>
                        <tbody id="jobsTableBody" class="text-sm">
                            </tbody>
                    </table>
                </div>
                <div id="emptyState" class="hidden p-8 text-center text-gray-500">
                    <i class="fa-solid fa-box-open text-4xl mb-2"></i>
                    <p>NO HAY TRABAJOS ACTIVOS</p>
                </div>
            </div>
        </div>
    </section>

    <section id="view-timer" class="fixed inset-0 bg-gray-900 text-white z-50 hidden flex flex-col">
        <div class="p-6 flex justify-between items-start">
            <div>
                <h3 id="timerInstrument" class="text-2xl font-bold text-gray-400">GUITARRA FENDER</h3>
                <p id="timerClient" class="text-lg text-gray-500">CLIENTE: JUAN PEREZ</p>
                <p id="timerTicket" class="text-sm text-gray-600">REF: T-12345</p>
            </div>
            <button onclick="closeTimer()" class="text-gray-500 hover:text-white text-2xl"><i class="fa-solid fa-times"></i></button>
        </div>

        <div class="flex-1 flex flex-col justify-center items-center text-center">
            <div id="timerDisplay" class="timer-display font-mono mb-8">00:00:00</div>
            
            <div class="flex gap-6">
                <button id="btnToggleTimer" onclick="toggleTimer()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-6 px-12 rounded-full text-2xl shadow-lg transition transform hover:scale-105">
                    <i class="fa-solid fa-play"></i> INICIAR
                </button>
                
                <button onclick="finishJob()" class="bg-red-600 hover:bg-red-500 text-white font-bold py-6 px-12 rounded-full text-2xl shadow-lg transition transform hover:scale-105">
                    <i class="fa-solid fa-flag-checkered"></i> TERMINAR
                </button>
            </div>
        </div>

        <div class="p-8 text-center bg-gray-800">
            <button id="whatsappBtn" onclick="sendWhatsApp()" class="bg-green-500 hover:bg-green-400 text-white font-bold py-4 px-8 rounded-lg shadow-lg w-full max-w-2xl text-xl flex items-center justify-center gap-3">
                <i class="fa-brands fa-whatsapp text-3xl"></i> NOTIFICAR AL CLIENTE
            </button>
        </div>
    </section>

    <div id="modalNewTicket" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg overflow-hidden">
            <div class="bg-gray-900 text-white p-4 font-bold flex justify-between">
                <span>NUEVA ORDEN DE SERVICIO</span>
                <button onclick="closeNewTicketModal()"><i class="fa-solid fa-times"></i></button>
            </div>
            <form id="newTicketForm" class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">CLIENTE</label>
                        <input type="text" name="cliente" class="w-full p-2 border rounded uppercase" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">TELÉFONO</label>
                        <input type="tel" name="telefono" class="w-full p-2 border rounded" placeholder="57300..." required>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">INSTRUMENTO</label>
                        <select name="instrumento" class="w-full p-2 border rounded uppercase">
                            <option>GUITARRA ELÉCTRICA</option>
                            <option>GUITARRA ACÚSTICA</option>
                            <option>BAJO</option>
                            <option>UKULELE</option>
                            <option>VIOLÍN</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">MARCA</label>
                        <input type="text" name="marca" class="w-full p-2 border rounded uppercase">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">SERIE (ID ÚNICO)</label>
                    <input type="text" name="serie" class="w-full p-2 border rounded uppercase" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">DIAGNÓSTICO INICIAL</label>
                    <textarea name="diagnostico" rows="3" class="w-full p-2 border rounded uppercase" required></textarea>
                </div>
                <button type="submit" class="w-full bg-gray-900 text-white font-bold py-3 rounded mt-2">CREAR TICKET</button>
            </form>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const API_URL = "https://script.google.com/macros/s/AKfycby_XX_R2hJDsRIPmgyrIXm_KYtHEu3DuzhKUoPo3QblN2Q4B5A4nszFXuvGhNh9LwYe/exec";
        
        // --- ESTADO LOCAL ---
        let currentUser = JSON.parse(localStorage.getItem('luthierUser')) || null;
        let activeTicket = null;
        let timerInterval = null;
        let secondsElapsed = 0;
        let isTimerRunning = false;

        // --- INICIALIZACIÓN ---
        window.addEventListener('load', () => {
            if (currentUser) {
                showDashboard();
            } else {
                document.getElementById('view-login').classList.remove('hidden');
            }
        });

        // --- SISTEMA DE LOGIN ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = document.getElementById('user').value;
            const pass = document.getElementById('pass').value;
            
            showLoader(true);
            try {
                const result = await fetchAPI({ action: "login", usuario: user, clave: pass });
                if (result.status === "success") {
                    currentUser = result.data;
                    localStorage.setItem('luthierUser', JSON.stringify(currentUser));
                    showDashboard();
                } else {
                    Swal.fire('Error', 'Credenciales incorrectas', 'error');
                }
            } catch (error) {
                Swal.fire('Error', 'Error de conexión con el servidor', 'error');
            }
            showLoader(false);
        });

        function logout() {
            localStorage.removeItem('luthierUser');
            location.reload();
        }

        // --- DASHBOARD ---
        function showDashboard() {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-dashboard').classList.remove('hidden');
            document.getElementById('luthierName').textContent = currentUser.nombre;
            loadDashboard();
        }

        async function loadDashboard() {
            showLoader(true);
            try {
                const result = await fetchAPI({ action: "getDashboardData", sheetId: currentUser.sheetId });
                renderTable(result.data);
            } catch (error) {
                console.error(error);
            }
            showLoader(false);
        }

        function renderTable(data) {
            const tbody = document.getElementById('jobsTableBody');
            const empty = document.getElementById('emptyState');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            data.forEach(job => {
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-gray-50 transition";
                tr.innerHTML = `
                    <td class="p-4 font-bold text-gray-900">${job.ticketId}</td>
                    <td class="p-4 uppercase">${job.cliente}</td>
                    <td class="p-4 text-gray-600 uppercase">${job.instrumento} <br><span class="text-xs text-gray-400">${job.serie}</span></td>
                    <td class="p-4"><span class="bg-yellow-100 text-yellow-800 py-1 px-3 rounded-full text-xs font-bold">${job.estado}</span></td>
                    <td class="p-4 text-center">
                        <button onclick='openTimer(${JSON.stringify(job)})' class="bg-gray-900 text-white p-2 rounded hover:bg-gray-700 w-10 h-10 flex items-center justify-center mx-auto shadow">
                            <i class="fa-solid fa-clock"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Buscador Local
        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#jobsTableBody tr');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        });

        // --- CRONÓMETRO GIGANTE ---
        function openTimer(job) {
            activeTicket = job;
            document.getElementById('view-timer').classList.remove('hidden');
            
            document.getElementById('timerInstrument').textContent = job.instrumento;
            document.getElementById('timerClient').textContent = "CLIENTE: " + job.cliente;
            document.getElementById('timerTicket').textContent = "REF: " + job.ticketId;
            
            // Cargar tiempo previo si existe (formato HH:MM:SS)
            secondsElapsed = parseTime(job.tiempo || "00:00:00");
            updateDisplay();
            
            // Resetear estado botones
            isTimerRunning = false;
            updateTimerUI();
        }

        function closeTimer() {
            if (isTimerRunning) {
                Swal.fire('Cronómetro Activo', 'Pausa el cronómetro antes de salir.', 'warning');
                return;
            }
            document.getElementById('view-timer').classList.add('hidden');
            loadDashboard(); // Recargar datos al volver
        }

        function toggleTimer() {
            if (isTimerRunning) {
                // PAUSAR
                clearInterval(timerInterval);
                isTimerRunning = false;
                // Opcional: Guardar progreso parcial aquí
            } else {
                // INICIAR
                timerInterval = setInterval(() => {
                    secondsElapsed++;
                    updateDisplay();
                }, 1000);
                isTimerRunning = true;
            }
            updateTimerUI();
        }

        function updateTimerUI() {
            const btn = document.getElementById('btnToggleTimer');
            if (isTimerRunning) {
                btn.innerHTML = '<i class="fa-solid fa-pause"></i> PAUSAR';
                btn.className = "bg-yellow-500 hover:bg-yellow-400 text-white font-bold py-6 px-12 rounded-full text-2xl shadow-lg transition transform hover:scale-105";
            } else {
                btn.innerHTML = '<i class="fa-solid fa-play"></i> CONTINUAR';
                btn.className = "bg-green-600 hover:bg-green-500 text-white font-bold py-6 px-12 rounded-full text-2xl shadow-lg transition transform hover:scale-105";
            }
        }

        function updateDisplay() {
            const hrs = Math.floor(secondsElapsed / 3600);
            const mins = Math.floor((secondsElapsed % 3600) / 60);
            const secs = secondsElapsed % 60;
            document.getElementById('timerDisplay').textContent = 
                `${pad(hrs)}:${pad(mins)}:${pad(secs)}`;
        }

        async function finishJob() {
            if (isTimerRunning) toggleTimer(); // Pausar primero

            const { value: confirm } = await Swal.fire({
                title: '¿TERMINAR TRABAJO?',
                text: "Se registrará el tiempo y se notificará listo para entrega.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#1f2937',
                confirmButtonText: 'SÍ, TERMINAR'
            });

            if (confirm) {
                showLoader(true);
                // NOTA: Como el backend actual solo tiene "saveTicket" (crear nuevo),
                // enviaremos un nuevo registro con estado TERMINADO para mantener historial.
                // En una v2.0 se debería implementar "updateTicket".
                
                const finalTime = document.getElementById('timerDisplay').textContent;
                
                // Simulamos guardar el cierre
                // En un escenario real, necesitamos un endpoint 'update'
                // Aquí usamos saveTicket para agregar el registro de cierre
                try {
                    await fetchAPI({
                        action: "saveTicket",
                        sheetId: currentUser.sheetId,
                        ticketData: {
                            id: activeTicket.ticketId, // Mismo ID
                            cliente: activeTicket.cliente,
                            instrumento: activeTicket.instrumento.split(" ")[0], // Hack simple
                            marca: "",
                            serie: activeTicket.serie,
                            estado: "TERMINADO",
                            diagnostico: "TRABAJO FINALIZADO. TIEMPO TOTAL: " + finalTime
                        }
                    });
                    
                    Swal.fire('¡Excelente!', 'El trabajo ha sido registrado.', 'success');
                    // Mostrar botón WhatsApp
                } catch (e) {
                    Swal.fire('Atención', 'Datos guardados localmente (Backend requiere actualización para edición real)', 'warning');
                }
                showLoader(false);
            }
        }

        // --- WHATSAPP ---
        function sendWhatsApp() {
            if (!activeTicket) return;
            // Mensaje: "HOLA [CLIENTE], TU [INSTRUMENTO] ESTÁ LISTO. COORDINEMOS LA ENTREGA."
            const msg = `HOLA ${activeTicket.cliente}, TU ${activeTicket.instrumento} ESTÁ LISTO. COORDINEMOS LA ENTREGA.`;
            // Nota: Necesitamos el teléfono. Si no viene en la data, pedimos al usuario o usamos un placeholder.
            // Aquí asumimos que el usuario lo tiene en su agenda y solo abrimos la API
            const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }

        // --- NUEVO TICKET ---
        function openNewTicketModal() { document.getElementById('modalNewTicket').classList.remove('hidden'); }
        function closeNewTicketModal() { document.getElementById('modalNewTicket').classList.add('hidden'); }

        document.getElementById('newTicketForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const ticketData = Object.fromEntries(formData.entries());
            
            showLoader(true);
            try {
                await fetchAPI({
                    action: "saveTicket",
                    sheetId: currentUser.sheetId,
                    ticketData: ticketData
                });
                closeNewTicketModal();
                e.target.reset();
                Swal.fire('Guardado', 'Ticket creado correctamente', 'success');
                loadDashboard();
            } catch (error) {
                Swal.fire('Error', 'No se pudo crear el ticket', 'error');
            }
            showLoader(false);
        });

        // --- UTILIDADES ---
        async function fetchAPI(data) {
            // Usamos mode: 'no-cors' si hay problemas, pero idealmente usamos la respuesta JSON
            // Google Apps Script requiere text/plain para evitar preflight complex CORS issues a veces,
            // pero el script backend fue configurado para JSON.
            const response = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify(data)
            });
            return await response.json();
        }

        function showLoader(show) {
            const loader = document.getElementById('loader');
            if (show) loader.classList.remove('hidden');
            else loader.classList.add('hidden');
        }

        function pad(val) { return val > 9 ? val : "0" + val; }
        
        function parseTime(timeStr) {
            if(!timeStr) return 0;
            // Formato esperado HH:MM:SS o objeto Date
            if (typeof timeStr !== 'string') return 0;
            const parts = timeStr.split(':');
            if (parts.length !== 3) return 0;
            return (+parts[0]) * 3600 + (+parts[1]) * 60 + (+parts[2]);
        }
    </script>
</body>
</html>
